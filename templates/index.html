<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chairman POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <style>
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .cart-section { flex: 1; overflow-y: auto; }
        .autocomplete-dropdown { max-height: 300px; overflow-y: auto; }
        .autocomplete-item.selected { background-color: #fee2e2 !important; }
        .qty-input { width: 70px; }
        .scanner-ready { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Top Bar -->
    <nav class="bg-gradient-to-r from-red-700 to-red-800 shadow-lg">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="bi bi-shop text-white text-2xl"></i>
                <span class="text-white text-xl font-bold">Chairman POS</span>
            </div>
            <div class="flex items-center gap-3">
                <!-- Printer Selector -->
                <div class="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full">
                    <i class="bi bi-printer text-white"></i>
                    <select id="printerSelect" class="bg-transparent text-white text-sm border-0 focus:ring-0 cursor-pointer">
                        <option value="">Loading printers...</option>
                    </select>
                    <button onclick="testPrint()" class="text-white hover:text-green-300 ml-1" title="Test Print">
                        <i class="bi bi-printer-fill"></i>
                    </button>
                </div>
                <span class="scanner-ready text-green-300 text-sm flex items-center gap-1">
                    <i class="bi bi-upc-scan"></i> Scanner
                </span>
                <span class="bg-white/20 text-white px-3 py-1 rounded-full text-sm">
                    <i class="bi bi-person-circle"></i> rapid
                </span>
            </div>
        </div>
    </nav>

    <!-- Search -->
    <div class="bg-white border-b shadow-sm px-4 py-3">
        <div class="flex items-center gap-3">
            <label class="font-semibold text-gray-700"><i class="bi bi-search"></i> Search:</label>
            <div class="relative flex-1 max-w-lg">
                <input type="text" id="searchInput" 
                       class="form-control w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring focus:ring-red-200 pl-4 pr-10 py-2"
                       placeholder="Type product name or scan barcode..." autocomplete="off">
                <div id="autocompleteDropdown" class="autocomplete-dropdown hidden absolute top-full left-0 right-0 mt-1 bg-white border rounded-lg shadow-xl z-50">
                    <div id="autocompleteResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart -->
    <div class="flex-1 overflow-hidden flex flex-col p-3">
        <div class="cart-section bg-white rounded-xl shadow-lg overflow-hidden">
            <table class="table table-hover mb-0 w-full">
                <thead class="bg-red-700 text-white sticky top-0">
                    <tr>
                        <th class="px-3 py-2 w-10">#</th>
                        <th class="px-3 py-2 w-20">Code</th>
                        <th class="px-3 py-2">Item</th>
                        <th class="px-3 py-2 text-right w-24">Price</th>
                        <th class="px-3 py-2 text-center w-20">Qty</th>
                        <th class="px-3 py-2 text-right w-28">Subtotal</th>
                        <th class="px-3 py-2 w-12"></th>
                    </tr>
                </thead>
                <tbody id="cartBody"></tbody>
            </table>
            <div id="emptyCart" class="text-center py-12 text-gray-400">
                <i class="bi bi-cart3 text-5xl mb-2 block"></i>
                <p>Cart is empty</p>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bg-white border-t shadow-lg px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex gap-4">
                <a href="#" class="text-red-700 hover:text-red-800 font-medium"><i class="bi bi-graph-up"></i> Sales</a>
                <a href="#" class="text-red-700 hover:text-red-800 font-medium"><i class="bi bi-box-seam"></i> Stock</a>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div class="text-xs text-gray-500 uppercase">Total</div>
                    <div class="text-4xl font-bold text-red-700" id="totalDisplay">0.00</div>
                </div>
                <button onclick="openPaymentModal()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg transition">
                    <i class="bi bi-cash-stack me-2"></i>SELL (F5)
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-red-700 to-red-800 text-white px-5 py-3 flex justify-between items-center">
                <span class="text-lg font-bold"><i class="bi bi-wallet2 me-2"></i>Payment</span>
                <button onclick="closePaymentModal()" class="hover:bg-white/20 p-1 rounded"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="p-5">
                <!-- Payment Type -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button id="btnCash" onclick="selectPaymentType('cash')" class="flex flex-col items-center py-3 border-2 border-red-600 bg-red-50 text-red-700 rounded-xl font-semibold">
                        <i class="bi bi-cash text-xl mb-1"></i> Cash
                    </button>
                    <button id="btnMpesa" onclick="selectPaymentType('mpesa')" class="flex flex-col items-center py-3 border-2 border-gray-300 rounded-xl font-semibold">
                        <i class="bi bi-phone text-xl mb-1"></i> M-Pesa
                    </button>
                </div>

                <!-- Total -->
                <div class="bg-gray-50 rounded-xl p-4 mb-4 flex justify-between items-center">
                    <span class="text-gray-600 font-medium">TOTAL</span>
                    <span class="text-3xl font-bold text-red-700" id="paymentTotal">0.00</span>
                </div>

                <!-- Cash Fields -->
                <div id="cashFields">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount Given</label>
                        <input type="number" id="paymentAmtGiven" oninput="calculateChange()" 
                               class="form-control w-full text-xl text-right py-2 rounded-lg" placeholder="0.00">
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 flex justify-between items-center">
                        <span class="text-green-700 font-medium">CHANGE</span>
                        <span class="text-3xl font-bold text-green-600" id="paymentChange">0.00</span>
                    </div>
                </div>

                <!-- M-Pesa Fields -->
                <div id="mpesaFields" class="hidden">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="mpesaNumber" maxlength="10"
                               class="form-control w-full text-xl py-2 rounded-lg" placeholder="07XXXXXXXX">
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-xl p-3 text-sm text-green-700">
                        <i class="bi bi-info-circle"></i> STK Push: <strong>KES <span id="mpesaAmount">0.00</span></strong>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 mt-5">
                    <button onclick="closePaymentModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold">Cancel</button>
                    <button onclick="confirmPayment()" id="confirmPayBtn" class="flex-1 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-semibold shadow">
                        <i class="bi bi-printer me-1"></i> Pay & Print (F5)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- M-PESA Loader Modal -->
    <div id="mpesaLoaderModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-5 py-3">
                <span class="text-lg font-bold"><i class="bi bi-phone me-2"></i>Waiting for M-PESA Confirmation</span>
            </div>
            <div class="p-8 text-center">
                <div class="mb-4">
                    <div class="inline-block">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-blue-600"></div>
                    </div>
                </div>
                <p class="text-gray-600 font-medium mb-2">STK Prompt sent to <span id="loaderPhone" class="font-bold"></span></p>
                <p class="text-gray-500 text-sm mb-4">Enter your M-PESA PIN to confirm payment</p>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-blue-700 font-bold text-2xl">KES <span id="loaderAmount">0.00</span></p>
                </div>
                <p class="text-gray-500 text-xs mb-4">Waiting... (max 120 seconds)</p>
                <button onclick="cancelMpesaPayment()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold">
                    Cancel Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-4 right-4 px-5 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50">
        <i class="bi" id="toastIcon"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        // ========== GLOBALS ==========
        let cart = [];
        let total = 0;
        let paymentType = 'cash';
        let selectedIndex = -1;
        let barcodeBuffer = '';
        let barcodeTimeout = null;
        let paymentModalOpen = false;
        let selectedPrinter = '';
        let mpesaCheckInterval = null;
        let mpesaCheckCount = 0;
        let currentMpesaData = null;

        let products = [];

        let fuse;

        // ========== LOAD PRODUCTS ==========
        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                const data = await res.json();
                
                if (data.success && data.products) {
                    products = data.products.map(p => ({
                        id: p.id,
                        barcode: p.barcode || p.code || '',
                        description: p.name || p.description || '',
                        price: parseFloat(p.price) || 0,
                        stock: p.quantity_in_stock || 0,
                        code: p.code,
                        name: p.name
                    }));
                    
                    // Initialize Fuse with loaded products
                    fuse = new Fuse(products, {
                        keys: ['description', 'name', 'barcode', 'code'],
                        threshold: 0.3,
                        minMatchCharLength: 2
                    });
                    
                    console.log(`âœ“ Loaded ${products.length} products from database`);
                } else {
                    console.error('Failed to load products:', data.error);
                    showToast('Failed to load products from database', 'error');
                }
            } catch (e) {
                console.error('Products load error:', e);
                showToast('Error loading products: ' + e.message, 'error');
            }
        }

        // ========== PRINTER ==========
        async function loadPrinters() {
            try {
                const res = await fetch('/api/printers');
                const data = await res.json();
                
                if (data.success) {
                    const select = document.getElementById('printerSelect');
                    select.innerHTML = '';
                    
                    data.printers.forEach(printer => {
                        const opt = document.createElement('option');
                        opt.value = printer;
                        opt.textContent = printer;
                        if (printer === data.default) {
                            opt.selected = true;
                            selectedPrinter = printer;
                        }
                        select.appendChild(opt);
                    });
                    
                    select.onchange = () => selectedPrinter = select.value;
                }
            } catch (e) {
                console.error('Failed to load printers:', e);
            }
        }

        async function testPrint() {
            showToast('Sending test print...', 'info');
            try {
                const res = await fetch('/api/test-print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ printer: selectedPrinter })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('Test print sent!', 'success');
                } else {
                    showToast('Print failed: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function printReceipt() {
            const paid = parseFloat(document.getElementById('paymentAmtGiven').value) || total;
            const change = Math.max(0, paid - total);
            
            try {
                const res = await fetch('/api/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        printer: selectedPrinter,
                        cart: cart,
                        total: total,
                        paid: paid,
                        change: change,
                        paymentType: paymentType
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('Sale #' + data.sale_id + ' - Receipt printed!', 'success');
                    return true;
                } else {
                    showToast('Print error: ' + data.error, 'error');
                    return false;
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
                return false;
            }
        }

        // ========== CART ==========
        function renderCart() {
            const cartBody = document.getElementById('cartBody');
            const emptyCart = document.getElementById('emptyCart');
            cartBody.innerHTML = '';
            total = 0;

            if (cart.length === 0) {
                emptyCart.classList.remove('hidden');
            } else {
                emptyCart.classList.add('hidden');
                cart.forEach((item, i) => {
                    total += item.subtotal;
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-red-50';
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-gray-500">${i + 1}</td>
                        <td class="px-3 py-2"><code class="bg-gray-100 px-1 rounded text-xs">${item.barcode}</code></td>
                        <td class="px-3 py-2 font-medium">${item.description}</td>
                        <td class="px-3 py-2 text-right">${item.price.toFixed(2)}</td>
                        <td class="px-3 py-2 text-center">
                            <input type="number" class="qty-input form-control text-center py-1" 
                                   value="${item.qty}" min="1" onchange="updateQty(${i}, this.value)">
                        </td>
                        <td class="px-3 py-2 text-right font-semibold">${item.subtotal.toFixed(2)}</td>
                        <td class="px-3 py-2 text-center">
                            <button onclick="removeItem(${i})" class="text-red-500 hover:text-red-700"><i class="bi bi-x-lg"></i></button>
                        </td>
                    `;
                    cartBody.appendChild(tr);
                });
            }
            document.getElementById('totalDisplay').textContent = total.toFixed(2);
        }

        function addToCart(product, increment = true) {
            const existing = cart.find(c => c.barcode === product.barcode);
            if (existing) {
                if (increment) {
                    existing.qty++;
                    existing.subtotal = existing.price * existing.qty;
                }
            } else {
                cart.push({
                    id: product.id,
                    barcode: product.barcode,
                    description: product.description,
                    price: product.price,
                    qty: 1,
                    subtotal: product.price
                });
            }
            renderCart();
            closeAutocomplete();
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
        }

        function updateQty(i, val) {
            const qty = Math.max(1, parseInt(val) || 1);
            cart[i].qty = qty;
            cart[i].subtotal = cart[i].price * qty;
            renderCart();
        }

        function removeItem(i) {
            cart.splice(i, 1);
            renderCart();
        }

        // ========== SEARCH ==========
        function showAutocomplete(results) {
            const dropdown = document.getElementById('autocompleteDropdown');
            const container = document.getElementById('autocompleteResults');
            container.innerHTML = '';
            selectedIndex = -1;

            if (!results.length) {
                dropdown.classList.add('hidden');
                return;
            }

            results.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item px-4 py-2 cursor-pointer hover:bg-red-50 flex justify-between items-center border-b';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${p.description}</div>
                        <div class="text-xs text-gray-500">${p.barcode} | Stock: ${p.stock}</div>
                    </div>
                    <div class="text-red-700 font-bold">${p.price.toFixed(2)}</div>
                `;
                div.onclick = () => addToCart(p);
                div.dataset.index = i;
                container.appendChild(div);
            });
            dropdown.classList.remove('hidden');
        }

        function closeAutocomplete() {
            document.getElementById('autocompleteDropdown').classList.add('hidden');
            selectedIndex = -1;
        }

        function navigateAutocomplete(dir) {
            const items = document.querySelectorAll('.autocomplete-item');
            if (!items.length) return;
            items.forEach(el => el.classList.remove('selected', 'bg-red-100'));
            selectedIndex = dir === 'down' 
                ? (selectedIndex + 1) % items.length 
                : (selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1);
            items[selectedIndex].classList.add('selected', 'bg-red-100');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
        }

        // ========== BARCODE ==========
        function handleBarcode(char) {
            clearTimeout(barcodeTimeout);
            barcodeBuffer += char;
            barcodeTimeout = setTimeout(() => {
                if (barcodeBuffer.length >= 5) {
                    const product = products.find(p => p.barcode === barcodeBuffer);
                    if (product) addToCart(product, false);
                }
                barcodeBuffer = '';
            }, 100);
        }

        // ========== PAYMENT ==========
        function openPaymentModal() {
            if (!cart.length) {
                showToast('Cart is empty', 'error');
                return;
            }
            paymentModalOpen = true;
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('paymentTotal').textContent = total.toFixed(2);
            document.getElementById('mpesaAmount').textContent = total.toFixed(2);
            document.getElementById('paymentAmtGiven').value = '';
            document.getElementById('paymentChange').textContent = '0.00';
            selectPaymentType('cash');
        }

        function closePaymentModal() {
            paymentModalOpen = false;
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function selectPaymentType(type) {
            paymentType = type;
            document.getElementById('btnCash').className = `flex flex-col items-center py-3 border-2 rounded-xl font-semibold ${type === 'cash' ? 'border-red-600 bg-red-50 text-red-700' : 'border-gray-300'}`;
            document.getElementById('btnMpesa').className = `flex flex-col items-center py-3 border-2 rounded-xl font-semibold ${type === 'mpesa' ? 'border-red-600 bg-red-50 text-red-700' : 'border-gray-300'}`;
            document.getElementById('cashFields').classList.toggle('hidden', type !== 'cash');
            document.getElementById('mpesaFields').classList.toggle('hidden', type !== 'mpesa');
            setTimeout(() => document.getElementById(type === 'cash' ? 'paymentAmtGiven' : 'mpesaNumber').focus(), 100);
        }

        function calculateChange() {
            const amt = parseFloat(document.getElementById('paymentAmtGiven').value) || 0;
            document.getElementById('paymentChange').textContent = Math.max(0, amt - total).toFixed(2);
        }

        async function confirmPayment() {
            if (paymentType === 'cash') {
                const amt = parseFloat(document.getElementById('paymentAmtGiven').value) || 0;
                if (amt < total) {
                    showToast('Insufficient amount', 'error');
                    return;
                }
                // Cash payment - print immediately
                const printed = await printReceipt();
                if (printed) {
                    cart = [];
                    renderCart();
                    closePaymentModal();
                }
            } else {
                // M-PESA payment
                const phone = document.getElementById('mpesaNumber').value;
                if (!phone || phone.length < 10) {
                    showToast('Invalid phone number', 'error');
                    return;
                }
                
                // Initiate M-PESA STK push
                await initiateM2pesaPayment(phone);
            }
        }

        async function initiateM2pesaPayment(phoneNumber) {
            try {
                showToast('Sending STK prompt...', 'info');
                
                const payload = {
                    phone_number: phoneNumber,
                    amount: total,
                    cart: cart,
                    cashier_id: 1
                };
                
                console.log('ðŸ“± Sending STK Request:', payload);
                
                const res = await fetch('/api/mpesa_stk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('ðŸ“¡ Response status:', res.status);
                const data = await res.json();
                console.log('ðŸ“¥ Response data:', data);
                
                if (data.success) {
                    showToast('STK sent! Check your phone', 'success');
                    
                    // Store M-PESA transaction data for polling
                    currentMpesaData = {
                        sale_id: data.sale_id,
                        checkout_request_id: data.checkout_request_id,
                        phone: phoneNumber
                    };
                    
                    // Close payment modal and show loader
                    closePaymentModal();
                    showMpesaLoader(phoneNumber, total);
                    
                    // Start polling for payment confirmation
                    startMpesaPaymentCheck();
                } else {
                    const errorMsg = data.message || data.error || 'Unknown error';
                    console.error('âŒ STK Error:', errorMsg);
                    showToast('Failed to send STK: ' + errorMsg, 'error');
                }
            } catch (e) {
                console.error('âŒ Exception:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        function showMpesaLoader(phone, amount) {
            document.getElementById('loaderPhone').textContent = phone.slice(0, 3) + '***' + phone.slice(-4);
            document.getElementById('loaderAmount').textContent = amount.toFixed(2);
            document.getElementById('mpesaLoaderModal').classList.remove('hidden');
        }

        function hideMpesaLoader() {
            document.getElementById('mpesaLoaderModal').classList.add('hidden');
        }

        function startMpesaPaymentCheck() {
            mpesaCheckCount = 0;
            mpesaCheckInterval = setInterval(checkMpesaPayment, 3000); // Check every 3 seconds
        }

        async function checkMpesaPayment() {
            if (!currentMpesaData) {
                clearInterval(mpesaCheckInterval);
                return;
            }
            
            mpesaCheckCount++;
            
            // Stop after 40 checks (2 minutes)
            if (mpesaCheckCount > 40) {
                clearInterval(mpesaCheckInterval);
                hideMpesaLoader();
                showToast('Payment confirmation timeout. Please check your phone or try again.', 'error');
                currentMpesaData = null;
                return;
            }
            
            try {
                const res = await fetch('/api/mpesa_confirm_and_print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sale_id: currentMpesaData.sale_id,
                        checkout_request_id: currentMpesaData.checkout_request_id,
                        printer: selectedPrinter,
                        cart: cart
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Payment successful and receipt printed
                    clearInterval(mpesaCheckInterval);
                    hideMpesaLoader();
                    showToast(data.message, 'success');
                    
                    // Clear cart and reset
                    cart = [];
                    renderCart();
                    currentMpesaData = null;
                } else if (data.status === 'pending' || data.error === 'Payment not confirmed yet') {
                    // Still waiting for payment
                    // Just continue polling
                } else {
                    // Some other error
                    clearInterval(mpesaCheckInterval);
                    hideMpesaLoader();
                    showToast('Error: ' + data.error, 'error');
                    currentMpesaData = null;
                }
            } catch (e) {
                // Network error, keep trying
                console.error('Check payment error:', e);
            }
        }

        function cancelMpesaPayment() {
            clearInterval(mpesaCheckInterval);
            hideMpesaLoader();
            showToast('Payment cancelled', 'error');
            currentMpesaData = null;
            openPaymentModal();
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const message = document.getElementById('toastMessage');
            
            toast.className = `fixed bottom-4 right-4 px-5 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 ${
                type === 'success' ? 'bg-green-600 text-white' : 
                type === 'error' ? 'bg-red-600 text-white' : 
                'bg-blue-600 text-white'
            }`;
            icon.className = `bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : 'bi-info-circle'}`;
            message.textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // ========== EVENTS ==========
        document.getElementById('searchInput').addEventListener('input', function() {
            const q = this.value.trim();
            if (q.length < 2) {
                closeAutocomplete();
                return;
            }
            
            if (products.length === 0) {
                showToast('Loading products...', 'info');
                return;
            }
            
            const exact = products.find(p => p.barcode === q || p.code === q);
            showAutocomplete(exact ? [exact] : fuse.search(q).map(r => r.item).slice(0, 8));
        });

        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (document.getElementById('autocompleteDropdown').classList.contains('hidden')) return;
            if (e.key === 'ArrowDown') { e.preventDefault(); navigateAutocomplete('down'); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); navigateAutocomplete('up'); }
            else if (e.key === 'Enter') {
                e.preventDefault();
                const items = document.querySelectorAll('.autocomplete-item');
                if (selectedIndex >= 0) items[selectedIndex].click();
                else if (items.length === 1) items[0].click();
            }
            else if (e.key === 'Escape') closeAutocomplete();
        });

        document.addEventListener('keypress', function(e) {
            if (document.activeElement.tagName !== 'INPUT' && e.key.match(/[0-9]/)) {
                handleBarcode(e.key);
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5') {
                e.preventDefault();
                paymentModalOpen ? confirmPayment() : openPaymentModal();
            }
            if (e.key === 'Escape') { closePaymentModal(); closeAutocomplete(); }
            if (e.key === 'F2') { e.preventDefault(); document.getElementById('searchInput').focus(); }
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.relative')) closeAutocomplete();
        });

        // ========== INIT ==========
        loadProducts();
        loadPrinters();
        renderCart();
        document.getElementById('searchInput').focus();
    </script>
</body>
</html>